# Story 1.1: OpenSIPS Outbound Configuration

## Implementation Status: ✅ COMPLETED

### Overview
This story implements outbound call functionality for OpenSIPS to support IVR testing scenarios. The implementation includes:

- Outbound call management through OpenSIPS MI interface
- HTTP-based communication with OpenSIPS Management Interface
- Call state tracking and lifecycle management
- RTP port allocation for audio streams
- Integration with existing OpenSIPS infrastructure

### Components Implemented

#### 1. OutboundCallManager (`core/opensips/outbound_call_manager.py`)
- **Purpose**: Manages outbound SIP calls through OpenSIPS MI interface
- **Key Features**:
  - HTTP client for OpenSIPS MI communication
  - Call state management (INITIATING → CALLING → RINGING → CONNECTED → COMPLETED)
  - RTP port allocation and management
  - Event-driven architecture with callbacks
  - Graceful fallback to simulation when OpenSIPS is unavailable

#### 2. OpenSIPS Configuration (`config/opensips.cfg`)
- **Purpose**: OpenSIPS routing configuration for both inbound and outbound calls
- **Key Features**:
  - Dual routing for inbound (voice assistant) and outbound (IVR testing) calls
  - RTP proxy integration for media handling
  - MI interface configuration on port 8080
  - Dialog tracking for call management
  - Event notifications for call state changes

#### 3. Integration Updates (`core/opensips/integration.py`)
- **Purpose**: Updated OpenSIPS integration to support outbound calls
- **Key Features**:
  - Outbound call manager integration
  - Callback handlers for outbound call events
  - RTP transport setup for outbound calls
  - Unified interface for both inbound and outbound calls

### Technical Implementation Details

#### Call Initiation Process
1. **Call Creation**: Generate unique call ID and allocate RTP port
2. **MI Command**: Send `t_uac_dlg` command to OpenSIPS via HTTP POST
3. **State Tracking**: Monitor call progression through states
4. **Event Handling**: Process OpenSIPS events for state updates

#### MI Interface Commands
```json
// Call Initiation
{
  "jsonrpc": "2.0",
  "method": "t_uac_dlg",
  "params": [
    "sip:target@provider.com",           // Request URI
    "From: <sip:caller@host>;tag=...",   // From header
    "To: <sip:target@provider.com>",     // To header
    "Call-ID: unique_call_id",           // Call identifier
    "CSeq: 1 INVITE",                    // Command sequence
    "Contact: <sip:caller@host:port>",   // Contact header
    "User-Agent: OpenSIPS-IVR-Tester/1.0",
    "Content-Type: application/sdp",
    "SDP_BODY"                           // Session description
  ],
  "id": "call_id"
}

// Call Termination
{
  "jsonrpc": "2.0", 
  "method": "dlg_end_dlg",
  "params": ["call_id", "reason"],
  "id": "call_id_end"
}
```

#### RTP Configuration
- **Port Range**: 10000-10100 (even ports for RTP, odd for RTCP)
- **Audio Codecs**: PCMU (G.711 μ-law) and PCMA (G.711 A-law)
- **SDP Generation**: Dynamic SDP creation with allocated ports

### Error Handling and Resilience

#### HTTP Client Errors
- **Connection Failures**: Fallback to simulation mode for development
- **Timeout Handling**: 10-second timeout for MI requests
- **Session Management**: Automatic HTTP session lifecycle management

#### Call State Management
- **Invalid States**: Prevention of invalid state transitions
- **Cleanup**: Automatic cleanup of completed calls after 5 minutes
- **Shutdown**: Graceful termination of all active calls on shutdown

### Testing and Validation

#### Test Coverage
- ✅ Call manager initialization and configuration
- ✅ Call state enumeration and transitions
- ✅ RTP port allocation (even ports only)
- ✅ HTTP session lifecycle management
- ✅ Call initiation and termination flows
- ✅ Event handling and state updates
- ✅ Health check functionality
- ✅ Manager shutdown and cleanup

#### Demo Script (`demo_outbound_calls.py`)
- Complete demonstration of outbound call functionality
- Shows call lifecycle from initiation to termination
- Demonstrates RTP port allocation
- Includes error handling scenarios

### Integration Points

#### With Existing Architecture
- **OpenSIPS Integration**: Seamlessly integrated with existing inbound call handling
- **RTP Transport**: Reuses existing RTP infrastructure
- **Event System**: Compatible with existing event callback architecture
- **Configuration**: Uses existing OpenSIPS configuration patterns

#### Future Extensions
- **Load Balancing**: Ready for multiple OpenSIPS instances
- **Call Recording**: Infrastructure prepared for call recording
- **Advanced Routing**: Support for complex routing scenarios
- **Statistics**: Built-in call statistics and reporting capabilities

### Configuration Requirements

#### OpenSIPS Modules Required
```
loadmodule "mi_http.so"      # HTTP MI interface
loadmodule "dialog.so"       # Call tracking
loadmodule "uac.so"         # Outbound calls
loadmodule "rtpproxy.so"    # Media handling
loadmodule "b2b_entities.so" # Advanced call control
```

#### Network Configuration
- **MI Interface**: HTTP server on port 8080
- **SIP Signaling**: UDP/TCP on port 5060
- **RTP Media**: UDP ports 10000-10100
- **External Connectivity**: SIP trunk provider configuration

### Production Deployment Notes

#### Security Considerations
- **MI Interface**: Restrict access to localhost or secure network
- **SIP Authentication**: Configure UAC credentials for trunk access
- **RTP Security**: Consider SRTP for encrypted media streams

#### Performance Considerations
- **Connection Pooling**: HTTP session reuse for multiple calls
- **Port Management**: Efficient RTP port allocation and cleanup
- **Memory Management**: Automatic cleanup of completed calls

#### Monitoring and Logging
- **Call Tracking**: Comprehensive logging of call lifecycle
- **Health Checks**: Built-in health monitoring for OpenSIPS MI
- **Error Reporting**: Detailed error logging for troubleshooting

### Success Criteria - ✅ ACHIEVED
- [x] Outbound call initiation via OpenSIPS MI interface
- [x] Call state tracking and management
- [x] RTP port allocation and media setup
- [x] Integration with existing OpenSIPS infrastructure
- [x] Comprehensive error handling and fallback mechanisms
- [x] Complete test coverage and validation
- [x] Production-ready configuration and documentation

### Next Steps
With Story 1.1 completed, the system now supports both inbound voice assistant calls and outbound IVR testing calls. The next logical step would be to implement Story 1.2: Audio Stream Integration, which would enhance the RTP handling for bidirectional audio processing during IVR testing scenarios.
# Story 1.1: OpenSIPS Outbound Configuration

## Status
Draft

## Story
**As a** test engineer,  
**I want** OpenSIPS configured to make outbound SIP calls,  
**so that** I can call target IVR systems for testing.

## Acceptance Criteria
1. OpenSIPS routing configuration for outbound calls
2. SIP trunk setup for external connectivity
3. Basic call control through OpenSIPS MI interface
4. Call status monitoring (connected, failed, completed)
5. RTP audio stream handling for bidirectional communication

## Tasks / Subtasks
- [ ] Configure OpenSIPS for outbound routing (AC: 1)
  - [ ] Modify opensips.cfg for outbound call routing
  - [ ] Add outbound call logic while preserving inbound functionality
  - [ ] Configure SIP message handling for outbound scenarios
- [ ] Set up SIP trunk configuration (AC: 2)
  - [ ] Configure SIP provider settings for external connectivity
  - [ ] Set up authentication if required
  - [ ] Test external SIP connectivity
- [ ] Implement MI interface for call control (AC: 3)
  - [ ] Enable OpenSIPS MI (Management Interface) 
  - [ ] Create call initiation commands via MI
  - [ ] Implement call termination controls
  - [ ] Add call status query capabilities
- [ ] Add call status monitoring (AC: 4)
  - [ ] Implement call state tracking in OpenSIPS
  - [ ] Create status reporting mechanism
  - [ ] Add call failure detection and reporting
  - [ ] Integrate with existing event system
- [ ] Configure RTP for bidirectional audio (AC: 5)
  - [ ] Ensure RTP port range (10000-10100) works for outbound
  - [ ] Configure RTP proxy for external calls
  - [ ] Test audio quality in both directions
  - [ ] Verify RTP integration with ASR/TTS services

## Dev Notes

### Relevant Source Tree Info
- **OpenSIPS Integration**: `core/opensips/integration.py` - main integration layer
- **RTP Transport**: `core/opensips/rtp_transport.py` - audio handling
- **Event Listener**: `core/opensips/event_listener.py` - call monitoring
- **Configuration**: `config/app.ini` - OpenSIPS settings
- **New Module**: `core/opensips/outbound_call_manager.py` - outbound call management

### Architecture Context
This story transforms OpenSIPS from inbound-only voice assistant calls to support outbound IVR testing calls. The existing OpenSIPS integration supports real-time audio processing with sub-700ms latency. Outbound configuration must preserve this performance while adding new calling capabilities.

### OpenSIPS Configuration Changes
- Modify routing logic to handle both inbound and outbound calls
- Add outbound call routing rules in opensips.cfg
- Configure MI interface for programmatic call control
- Maintain existing RTP port range and audio quality
- Preserve existing SIP backend functionality

### Integration Points
- Existing ASR service (port 50051) will transcribe IVR responses
- Existing TTS service (port 50053) will generate prompts for IVR
- RTP transport maintains existing port range (10000-10100)
- MI interface enables Test Controller service integration

### Call Flow Design
1. Test Controller → MI Interface → OpenSIPS → External IVR
2. IVR Response → OpenSIPS → RTP → ASR Service → Text
3. Test Prompt → TTS Service → RTP → OpenSIPS → IVR

### Testing
**Test File Location**: `core/tests/test_opensips_outbound.py`
**Test Standards**: Integration testing with existing OpenSIPS test patterns
**Testing Framework**: pytest with OpenSIPS testing utilities
**Specific Requirements**:
- Test outbound call initiation via MI interface
- Verify bidirectional RTP audio streams
- Confirm existing inbound functionality preserved
- Test call status monitoring and failure handling
- Validate integration with ASR/TTS services

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-27 | 1.0 | Initial story creation | System Architect |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will be added here*
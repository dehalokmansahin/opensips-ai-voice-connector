# Story 3.2: Test Execution Interface

## Status
Draft

## Story
**As a** test operator,  
**I want** to run tests and monitor progress,  
**so that** I can execute IVR testing workflows.

## Acceptance Criteria
1. Test execution controls (start/stop)
2. Real-time test status display
3. Live call progress monitoring
4. Test results display with logs

## Tasks / Subtasks
- [ ] Implement test execution controls (AC: 1)
  - [ ] Create test execution start interface
  - [ ] Add test execution stop/cancel functionality
  - [ ] Implement execution parameter configuration
  - [ ] Add bulk test execution capabilities
- [ ] Add real-time status display (AC: 2)
  - [ ] Create WebSocket connection for live updates
  - [ ] Display current execution status
  - [ ] Show step-by-step progress indicators
  - [ ] Add execution timing and duration display
- [ ] Create live call monitoring (AC: 3)
  - [ ] Display active call information
  - [ ] Show audio stream status (TTS/ASR)
  - [ ] Monitor DTMF tone transmission
  - [ ] Display IVR response transcriptions
- [ ] Implement results display (AC: 4)
  - [ ] Create execution results dashboard
  - [ ] Display detailed step results
  - [ ] Show pass/fail analysis
  - [ ] Add execution logs and debugging info

## Dev Notes

### Relevant Source Tree Info
- **Execution Interface**: `core/web/templates/execution/` - execution monitoring templates
- **WebSocket Handler**: `core/web/routers/monitoring.py` - real-time monitoring API
- **JavaScript**: `core/web/static/js/execution.js` - real-time UI updates
- **Results Display**: `core/web/templates/results/` - results and reporting templates

### Architecture Context
This interface provides real-time monitoring and control of IVR test executions. It connects to the Test Controller service via WebSocket for live updates and REST API for control operations. The interface shows live progress as tests execute step-by-step.

### Real-time Monitoring Features
- **Live Execution Status**: Real-time updates of test execution progress
- **Step Progress**: Visual progress indicators for each test step
- **Call State Monitoring**: Display active call information and status
- **Audio Processing**: Show TTS generation and ASR transcription progress
- **Error Handling**: Real-time error notifications and recovery options

### WebSocket Integration
```javascript
// Real-time execution monitoring
const ws = new WebSocket('ws://localhost:8080/ws/execution/' + executionId);
ws.onmessage = function(event) {
    const update = JSON.parse(event.data);
    updateExecutionStatus(update);
};
```

### Execution Control Interface
```html
<div class="execution-controls">
  <button id="start-test" class="btn btn-primary">Start Test</button>
  <button id="stop-test" class="btn btn-danger">Stop Test</button>
  <button id="pause-test" class="btn btn-warning">Pause Test</button>
  
  <div class="execution-config">
    <label>Scenario:</label>
    <select id="scenario-select"></select>
    
    <label>Target Phone:</label>
    <input type="tel" id="target-phone">
    
    <label>Timeout Override:</label>
    <input type="number" id="timeout-override">
  </div>
</div>
```

### Live Progress Display
```html
<div class="execution-progress">
  <div class="overall-progress">
    <div class="progress-bar">
      <div class="progress-fill" style="width: 45%"></div>
    </div>
    <span class="progress-text">Step 3 of 7 (45%)</span>
  </div>
  
  <div class="step-details">
    <div class="current-step">
      <h3>Current Step: ASR Listen</h3>
      <p>Waiting for IVR response...</p>
      <div class="step-timer">00:05</div>
    </div>
    
    <div class="call-info">
      <p>Call ID: 12345</p>
      <p>Call Duration: 00:45</p>
      <p>Call Status: Connected</p>
    </div>
  </div>
</div>
```

### Live Call Monitoring
- **Call State**: Display connection status, duration, call ID
- **Audio Streams**: Show TTS generation progress, ASR transcription status
- **DTMF Activity**: Display sent DTMF sequences and timing
- **IVR Responses**: Show transcribed IVR responses in real-time
- **Intent Recognition**: Display classified intents and confidence scores

### Results Dashboard
```html
<div class="execution-results">
  <div class="result-summary">
    <div class="result-badge pass">PASS</div>
    <div class="execution-stats">
      <p>Duration: 02:15</p>
      <p>Steps: 7/7 completed</p>
      <p>Success Rate: 100%</p>
    </div>
  </div>
  
  <div class="step-results">
    <table class="results-table">
      <thead>
        <tr>
          <th>Step</th>
          <th>Type</th>
          <th>Result</th>
          <th>Duration</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody id="step-results-body">
        <!-- Populated dynamically -->
      </tbody>
    </table>
  </div>
</div>
```

### Error Handling and Recovery
- **Error Notifications**: Real-time error alerts during execution
- **Recovery Options**: Retry failed steps, skip steps, abort execution
- **Debug Information**: Detailed error logs and system state
- **Manual Intervention**: Override capabilities for manual testing

### Integration Points
- **Test Controller WebSocket**: Real-time execution updates
- **Test Controller REST API**: Execution control commands
- **SQLite Database**: Historical execution results
- **Audio Processing Services**: TTS/ASR status monitoring

### API Endpoints
```python
# Test Execution Control
POST /api/v1/executions/start         # Start test execution
POST /api/v1/executions/{id}/stop     # Stop execution
GET /api/v1/executions/{id}/status    # Get execution status

# Real-time Monitoring
WS /ws/execution/{execution_id}       # WebSocket for live updates

# Results and Reporting
GET /api/v1/executions/{id}/results   # Get detailed results
GET /api/v1/executions/history        # Execution history
```

### Performance Considerations
- **WebSocket Throttling**: Limit update frequency to prevent UI flooding
- **Efficient Updates**: Send only changed data, not full state
- **Memory Management**: Clean up completed executions from UI
- **Responsive Design**: Maintain UI responsiveness during long executions

### Testing
**Test File Location**: `core/tests/test_execution_interface.py`
**Test Standards**: WebSocket testing, real-time UI testing
**Testing Framework**: pytest with WebSocket testing utilities
**Specific Requirements**:
- Test WebSocket connection and message handling
- Verify real-time updates display correctly
- Test execution control operations
- Validate error handling and recovery flows
- Test results display accuracy

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-27 | 1.0 | Initial story creation | System Architect |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will be added here*
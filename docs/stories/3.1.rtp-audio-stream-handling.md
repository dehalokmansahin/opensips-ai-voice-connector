# Story 3.1: RTP Audio Stream Handling

## Status
Ready

## Story
**As a** telephony system,
**I want** proper RTP audio stream ingestion and transmission,
**so that** audio can flow bidirectionally between callers and the AI pipeline.

## Acceptance Criteria
1. RTP audio stream reception from OpenSIPS with 20ms packet handling (~160 bytes each)
2. RTP audio stream transmission back to OpenSIPS for caller playback
3. Real-time audio buffering and jitter handling
4. Packet loss detection and basic recovery mechanisms
5. RTP session management and cleanup
6. Monitoring of audio stream quality metrics

## Integration Verification
**IV1**: **Existing Functionality Verification** - Current gRPC service communication patterns remain functional during RTP stream processing
**IV2**: **Integration Point Verification** - RTP streams integrate properly with Pipecat orchestrator without disrupting AI pipeline timing
**IV3**: **Performance Impact Verification** - RTP processing maintains sub-700ms total latency requirement and doesn't impact other service performance

## Tasks / Subtasks

- [x] **Task 1: Implement UDP + Event Bus RTP Reception Strategy** (AC: 1, 3) - Selected from brainstorming
  - [x] Create UDP socket listener for RTP packet reception on AI Voice Connector service
  - [x] Implement event bus pattern for decoupling RTP reception from audio processing pipeline
  - [x] Configure 20ms packet handling with 160-byte payload processing for PCMU audio
  - [x] Add jitter buffer implementation with configurable depth for real-time audio smoothing
  - [x] Validate RTP packet headers (sequence numbers, timestamps, payload types)

- [ ] **Task 2: Implement Multi-threaded RTP Processing Pipeline** (AC: 1, 2, 3) - Selected from brainstorming
  - [ ] Design multi-threaded architecture for concurrent RTP ingestion and transmission
  - [ ] Create dedicated thread pool for RTP packet processing to maintain real-time constraints
  - [ ] Implement lock-free audio buffer queues for thread-safe audio data transfer
  - [ ] Add thread-safe metrics collection for RTP stream monitoring
  - [ ] Configure thread priority and scheduling for audio processing threads

- [ ] **Task 3: Implement PCMU Codec Pipeline Integration** (AC: 1, 2) - Selected from brainstorming
  - [ ] Create PCMU/PCM audio codec conversion module in audio/ directory
  - [ ] Implement real-time PCMU decoding for incoming RTP streams (8kHz, ulaw)
  - [ ] Add PCM to PCMU encoding for outbound RTP transmission
  - [ ] Integrate codec pipeline with existing Pipecat audio stream requirements
  - [ ] Validate audio quality and format conversion accuracy

- [ ] **Task 4: Implement Packet Loss Detection and Recovery** (AC: 4) - Risk mitigation strategy
  - [ ] Add RTP sequence number tracking for packet loss detection
  - [ ] Implement basic packet interpolation for small gap recovery
  - [ ] Create error reporting mechanism for significant packet loss scenarios
  - [ ] Add configurable tolerance thresholds for packet loss handling
  - [ ] Implement graceful degradation when packet loss exceeds thresholds

- [ ] **Task 5: Implement Event Replay Buffer System** (AC: 3, 4) - Risk mitigation from brainstorming
  - [ ] Create circular buffer for recent RTP packet history (configurable size)
  - [ ] Implement replay mechanism for recovering from temporary network interruptions
  - [ ] Add buffer overflow protection and automatic cleanup policies
  - [ ] Create monitoring for buffer usage and replay effectiveness
  - [ ] Integrate replay buffer with jitter handling for seamless audio recovery

- [ ] **Task 6: Implement RTP Session Management and Cleanup** (AC: 5)
  - [ ] Create RTP session lifecycle management in AI Voice Connector service
  - [ ] Add session state tracking (SETUP, ACTIVE, TEARDOWN) with proper cleanup
  - [ ] Implement automatic timeout handling for orphaned RTP sessions
  - [ ] Create session correlation with SIP call IDs from OpenSIPS integration
  - [ ] Add graceful session termination with proper resource cleanup

- [ ] **Task 7: Implement Audio Quality Monitoring and Metrics** (AC: 6)
  - [ ] Add Prometheus metrics for RTP stream quality (jitter, packet loss, latency)
  - [ ] Implement real-time audio level monitoring and silence detection
  - [ ] Create health check endpoints for RTP service status validation
  - [ ] Add structured logging for RTP events with correlation IDs
  - [ ] Implement configurable alerting thresholds for audio quality degradation

- [ ] **Task 8: Proof of Concept Validation and Testing** (AC: 1, 2, 3, 4, 5, 6) - Risk-First approach
  - [ ] Create minimal RTP echo test for validating bidirectional audio flow
  - [ ] Implement synthetic RTP packet generation for isolated testing
  - [ ] Add integration tests with OpenSIPS proxy for end-to-end validation
  - [ ] Create performance benchmarks for latency and throughput measurements
  - [ ] Validate compatibility with existing Pipecat audio pipeline integration

## Dev Notes

### Previous Story Dependencies
**Epic 1 Foundation**: All Phase 1 stories completed providing stable microservices architecture, gRPC communication, and development environment for implementing RTP audio handling.

### Brainstorming Session Implementation Strategy
**Philosophy**: Risk-First + PoC Validation approach focusing on critical audio transport reliability.

**Selected Strategies**:
- **UDP + Event Bus Pattern**: Decouples RTP reception from processing for better scalability [Brainstorming Decision]
- **Multi-threaded RTP Processing**: Ensures real-time audio constraints are met through dedicated threading [Brainstorming Decision]
- **PCMU Codec Pipeline**: Direct PCMU/PCM conversion avoiding unnecessary format changes [Brainstorming Decision]
- **Event Replay Buffer**: Provides recovery mechanism for network interruptions [Risk Mitigation Strategy]
- **Graceful Degradation**: Maintains service availability during audio quality issues [Risk Mitigation Strategy]

### Technical Constraints and Requirements
- **Technology Stack**: Python 3.11.7 with asyncio patterns for real-time audio processing [Source: docs/architecture/tech-stack.md]
- **Audio Processing**: PyAudio 0.2.13 for low-latency audio I/O handling [Source: docs/architecture/tech-stack.md]
- **Performance Requirement**: Sub-700ms total latency for complete voice processing pipeline [Source: docs/architecture/high-level-architecture.md]
- **Packet Timing**: 20ms RTP packet handling with ~160 bytes payload for PCMU/8000 audio [Source: Epic 3.1 AC]
- **Communication Protocol**: gRPC 1.60.0 for inter-service communication with type safety [Source: docs/architecture/tech-stack.md]

### Data Models and Session Management
- **CallSession Integration**: RTP sessions must correlate with existing session_id and sip_call_id tracking [Source: docs/architecture/data-models.md]
- **Session State Management**: RTP session lifecycle aligns with CallSession status enum (ACTIVE, COMPLETED, FAILED, INTERRUPTED) [Source: docs/architecture/data-models.md]
- **Audio Stream Correlation**: Each RTP stream requires unique identifier linking to CallSession.session_id for proper cleanup [Source: docs/architecture/data-models.md]

### File Locations and Structure
- **AI Voice Connector Service**: services/ai-voice-connector/ (main RTP handling service) [Source: docs/architecture/source-tree.md]
- **Audio Processing Module**: services/ai-voice-connector/src/audio/ directory for PCMU/PCM codecs [Source: docs/architecture/source-tree.md]
- **RTP Streaming Module**: services/ai-voice-connector/src/audio/streaming.py for RTP packet handling [Source: docs/architecture/source-tree.md]
- **Codec Implementation**: services/ai-voice-connector/src/audio/codecs.py for PCMU/PCM conversion [Source: docs/architecture/source-tree.md]
- **Protocol Definitions**: services/ai-voice-connector/proto/ for RTP-related gRPC service definitions [Source: docs/architecture/source-tree.md]

### Component Integration Requirements
- **AI Voice Connector**: Central orchestrator managing RTP streams and session lifecycle [Source: docs/architecture/components.md#ai-voice-connector]
- **Pipecat Integration**: RTP streams must integrate with existing Pipecat orchestrator for AI pipeline [Source: docs/architecture/components.md#pipecat-orchestrator]
- **Session Manager**: RTP session state coordination with existing session management service [Source: docs/architecture/components.md#session-manager]
- **OpenSIPS Dependency**: RTP streams originate from OpenSIPS proxy requiring proper SIP integration [Source: docs/architecture/components.md#ai-voice-connector]

### Audio Processing Architecture
- **Real-time Streaming**: asyncio-based audio processing matching existing service patterns [Source: docs/architecture/high-level-architecture.md]
- **Codec Requirements**: PCMU/8000 input format conversion to PCM for Pipecat processing [Source: docs/architecture/core-workflows.md]
- **Buffer Management**: Jitter handling and packet loss recovery maintaining audio continuity [Epic 3.1 AC requirements]
- **Quality Monitoring**: Integration with Prometheus metrics for audio stream health tracking [Source: docs/architecture/tech-stack.md]

### Risk Mitigation Technical Implementation
- **Event Replay Buffer**: Circular buffer maintaining configurable packet history for network recovery
- **Graceful Degradation**: Fallback mechanisms maintaining service availability during audio quality issues
- **Packet Loss Tolerance**: Configurable thresholds with interpolation for small gaps, alerts for significant loss
- **Thread Safety**: Lock-free queues and thread-safe metrics collection for multi-threaded RTP processing
- **Memory Management**: Automatic buffer cleanup with configurable TTL to prevent memory leaks

### Integration Safety Requirements
- **gRPC Compatibility**: Maintain existing inter-service communication patterns during RTP processing [Source: docs/architecture/grpc-api-specifications.md]
- **Pipecat Pipeline**: Preserve audio pipeline timing and format requirements for AI components [Source: docs/architecture/core-workflows.md]
- **Session Correlation**: Proper linking between RTP streams and existing session management [Source: docs/architecture/data-models.md]
- **Performance Isolation**: RTP processing must not impact other service performance or latency [IV3 requirement]

## Testing

### Testing Standards and Requirements
- **Framework**: pytest 7.4.3 with asyncio support for testing real-time audio processing [Source: docs/architecture/test-strategy-and-standards.md]
- **Coverage Goal**: 90% line coverage for RTP handling business logic, 80% overall service coverage [Source: docs/architecture/test-strategy-and-standards.md]
- **Test Organization**: Unit tests in services/ai-voice-connector/tests/ parallel to source structure [Source: docs/architecture/test-strategy-and-standards.md]
- **Integration Testing**: gRPC service communication and Pipecat pipeline integration validation [Source: docs/architecture/test-strategy-and-standards.md]

### RTP-Specific Testing Approach
- **Synthetic RTP Generation**: Create test RTP packet streams for isolated unit testing
- **Audio Quality Validation**: Measure codec conversion accuracy and audio integrity
- **Performance Testing**: Latency benchmarks for 20ms packet processing requirements
- **Packet Loss Simulation**: Test recovery mechanisms under various network conditions
- **Multi-threading Safety**: Validate thread-safe audio buffer operations under load

### Specific Test Requirements
- RTP packet reception and parsing accuracy with PCMU payload validation
- Bidirectional audio flow testing with synthetic OpenSIPS integration
- Jitter buffer effectiveness under simulated network variation
- Packet loss detection and recovery mechanism validation
- Session lifecycle management and cleanup verification
- Audio quality metrics accuracy and alerting threshold validation

### Performance and Quality Baselines
- **Packet Processing Time**: <20ms per RTP packet processing cycle
- **Audio Latency**: Contribution <100ms to total 700ms pipeline requirement
- **Packet Loss Tolerance**: Graceful handling up to 5% packet loss with recovery
- **Thread Performance**: Multi-threaded RTP processing without audio dropouts
- **Memory Usage**: Bounded buffer memory with automatic cleanup preventing leaks

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-27 | 1.0 | Initial story creation based on Epic 3.1 requirements and brainstorming session strategies | bmad-orchestrator |

## Dev Agent Record

### Agent Model Used
Claude Code - Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Task 1 implementation: core/audio/ module creation
- Basic functionality tests: test_task1_basic.py
- Import resolution: Fixed circular imports between core modules

### Completion Notes List
- **Task 1 COMPLETED**: UDP + Event Bus RTP Reception Strategy
  - Created core/audio/ module with 5 components:
    - event_bus.py: AudioEventBus for decoupled RTP processing
    - buffering.py: JitterBuffer and EventReplayBuffer implementations
    - codecs.py: PCMUCodec for telephony audio conversion
    - streaming.py: RTPAudioStreamer main service class
    - rtp_basic.py: Basic RTP packet structures
  - Implemented UDP socket listener with asyncio DatagramProtocol
  - Event bus pattern handles 7 event types (RTP_PACKET_RECEIVED, AUDIO_DATA_READY, etc.)
  - Jitter buffer provides configurable depth (60ms default) with packet interpolation
  - PCMU codec with pre-computed lookup tables for fast conversion
  - RTP packet validation for sequence numbers, timestamps, payload types
  - All components tested with test_task1_basic.py - 6 test categories passing

### File List
- core/audio/__init__.py
- core/audio/event_bus.py
- core/audio/buffering.py  
- core/audio/codecs.py
- core/audio/streaming.py
- core/audio/rtp_basic.py
- core/tests/test_audio_streaming.py
- test_task1_basic.py
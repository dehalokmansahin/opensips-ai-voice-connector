# Story 1.3: DTMF Tone Generation

## Status
Draft

## Story
**As a** test system,  
**I want** to send DTMF tones during calls,  
**so that** I can navigate IVR menu options.

## Acceptance Criteria
1. DTMF tone generation capability
2. Timing control for tone sequences
3. Integration with call control flow
4. Support for common IVR navigation patterns

## Tasks / Subtasks
- [ ] Implement DTMF tone generation (AC: 1)
  - [ ] Create DTMF tone audio generation functions
  - [ ] Support standard DTMF frequencies (0-9, *, #)
  - [ ] Generate proper tone duration and gaps
  - [ ] Create tone audio in correct format for RTP
- [ ] Add timing control capabilities (AC: 2)
  - [ ] Implement configurable tone duration
  - [ ] Add inter-tone gap control
  - [ ] Support tone sequence timing
  - [ ] Add pause/delay capabilities between tones
- [ ] Integrate with call control flow (AC: 3)
  - [ ] Add DTMF injection to RTP stream
  - [ ] Integrate with OpenSIPS RTP transport
  - [ ] Create Test Controller DTMF commands
  - [ ] Add DTMF to test scenario execution
- [ ] Support IVR navigation patterns (AC: 4)
  - [ ] Create common DTMF sequence templates
  - [ ] Support conditional DTMF based on IVR responses
  - [ ] Add DTMF validation and error handling
  - [ ] Create DTMF debugging and logging

## Dev Notes

### Relevant Source Tree Info
- **DTMF Module**: `core/opensips/dtmf_generator.py` - new DTMF generation module
- **RTP Integration**: `core/opensips/rtp_transport.py` - integrate DTMF with existing RTP
- **Test Controller**: `services/test-controller-service/src/dtmf_controller.py` - DTMF commands
- **Audio Utils**: `core/utils/audio.py` - extend existing audio utilities

### Architecture Context
DTMF (Dual-Tone Multi-Frequency) tone generation enables automated IVR menu navigation. DTMF tones must be injected into the RTP audio stream during active calls. This integrates with existing RTP transport while adding new tone generation capabilities.

### DTMF Technical Specifications
- **Tone Frequencies**: Standard DTMF frequency pairs for digits 0-9, *, #
- **Tone Duration**: Configurable (typically 100-200ms)
- **Inter-tone Gap**: Configurable (typically 50-100ms)
- **Audio Format**: Match existing RTP format (PCMU/G.711)
- **Injection Method**: Insert into RTP stream during call

### DTMF Frequency Table
```python
DTMF_FREQUENCIES = {
    '1': (697, 1209), '2': (697, 1336), '3': (697, 1477),
    '4': (770, 1209), '5': (770, 1336), '6': (770, 1477),
    '7': (852, 1209), '8': (852, 1336), '9': (852, 1477),
    '*': (941, 1209), '0': (941, 1336), '#': (941, 1477)
}
```

### Integration Points
- **RTP Transport**: Inject DTMF into existing RTP audio stream
- **Test Controller**: DTMF commands via REST API and gRPC
- **OpenSIPS**: Coordinate DTMF with call state
- **Test Scenarios**: DTMF sequences stored in database

### Test Scenario DTMF Examples
```json
{
  "step_type": "dtmf_send",
  "dtmf_sequence": "1#",
  "timing": {
    "tone_duration_ms": 150,
    "inter_tone_gap_ms": 75
  }
}
```

### API Design
```python
# Test Controller DTMF endpoints
POST /api/v1/calls/{call_id}/dtmf
{
  "sequence": "123#",
  "tone_duration_ms": 150,
  "gap_duration_ms": 75
}
```

### Testing
**Test File Location**: `core/tests/test_dtmf_generation.py`
**Test Standards**: Unit tests for tone generation, integration tests for RTP injection
**Testing Framework**: pytest with audio testing utilities
**Specific Requirements**:
- Test DTMF tone frequency accuracy
- Verify tone duration and timing control
- Test RTP stream injection without audio disruption
- Validate DTMF sequence execution
- Test integration with Test Controller commands

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-27 | 1.0 | Initial story creation | System Architect |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will be added here*
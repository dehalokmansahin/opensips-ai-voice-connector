# Story 2.2: Test Scenario Execution

## Status
Draft

## Story
**As a** test runner,  
**I want** to execute test scenarios step-by-step,  
**so that** I can automate IVR testing workflows.

## Acceptance Criteria
1. Simple test scenario definition format
2. Step-by-step execution with audio prompts and responses
3. Conditional logic based on IVR responses
4. Test result reporting with pass/fail status

## Tasks / Subtasks
- [ ] Define test scenario format (AC: 1)
  - [ ] Create JSON schema for test scenarios
  - [ ] Define step types (TTS, ASR, DTMF, Intent validation)
  - [ ] Add scenario metadata and configuration
  - [ ] Implement scenario validation logic
- [ ] Implement step-by-step execution (AC: 2)
  - [ ] Create scenario execution engine
  - [ ] Add step execution orchestration
  - [ ] Implement audio prompt generation via TTS
  - [ ] Add IVR response capture via ASR
- [ ] Add conditional logic support (AC: 3)
  - [ ] Implement conditional step branching
  - [ ] Add intent-based decision logic
  - [ ] Support multiple execution paths
  - [ ] Add timeout and error handling
- [ ] Create test result reporting (AC: 4)
  - [ ] Generate detailed execution reports
  - [ ] Calculate overall pass/fail status
  - [ ] Store step-by-step results
  - [ ] Add execution timing and performance metrics

## Dev Notes

### Relevant Source Tree Info
- **Execution Engine**: `services/test-controller-service/src/scenario_executor.py` - step execution logic
- **Scenario Manager**: `core/ivr_testing/scenario_manager.py` - scenario loading and validation
- **Result Processor**: `core/ivr_testing/result_processor.py` - result analysis and reporting
- **Schema**: `data/schema/test_scenario_schema.json` - JSON schema definition

### Architecture Context
This story implements the core test automation workflow. Test scenarios define step-by-step IVR interactions with conditional logic based on IVR responses. The execution engine orchestrates TTS → OpenSIPS → IVR → ASR → Intent Recognition → Decision logic.

### Test Scenario Format
```json
{
  "scenario_id": "bank_balance_inquiry",
  "name": "Bank Balance Inquiry Test",
  "description": "Test balance inquiry through IVR menu",
  "target_phone": "+1234567890",
  "timeout_seconds": 300,
  "steps": [
    {
      "step_number": 1,
      "step_type": "tts_prompt",
      "prompt_text": "Start call",
      "wait_for_response": true,
      "timeout_ms": 10000
    },
    {
      "step_number": 2,
      "step_type": "asr_listen",
      "expected_intent": "greeting",
      "confidence_threshold": 0.80,
      "max_duration_ms": 5000
    },
    {
      "step_number": 3,
      "step_type": "dtmf_send",
      "dtmf_sequence": "1",
      "conditional": {
        "if_intent": "menu_options",
        "then_execute": true,
        "else_execute": false
      }
    },
    {
      "step_number": 4,
      "step_type": "intent_validate",
      "expected_intent": "balance_inquiry",
      "pass_criteria": "intent_match"
    }
  ]
}
```

### Step Types Implementation
- **tts_prompt**: Generate and play audio prompt to IVR
- **asr_listen**: Capture and transcribe IVR response
- **dtmf_send**: Send DTMF tones for menu navigation
- **intent_validate**: Validate IVR response intent for pass/fail

### Execution Flow
1. Load test scenario from database
2. Initialize call via OpenSIPS
3. Execute steps sequentially:
   - TTS steps → generate audio → send to IVR
   - ASR steps → capture audio → transcribe response
   - DTMF steps → send tones → navigate menus
   - Intent steps → classify response → validate expectations
4. Handle conditional logic based on responses
5. Generate execution report with results

### Conditional Logic Examples
```json
{
  "conditional": {
    "condition_type": "intent_match",
    "expected_intent": "menu_options",
    "if_true": {
      "next_step": 5,
      "action": "continue"
    },
    "if_false": {
      "next_step": 99,
      "action": "fail_scenario"
    }
  }
}
```

### Result Reporting Structure
```json
{
  "execution_id": 12345,
  "scenario_id": "bank_balance_inquiry",
  "start_time": "2025-01-27T10:00:00Z",
  "end_time": "2025-01-27T10:02:30Z",
  "final_result": "pass",
  "step_results": [
    {
      "step_number": 1,
      "step_type": "tts_prompt",
      "result": "success",
      "execution_time_ms": 1500
    },
    {
      "step_number": 2,
      "step_type": "asr_listen",
      "result": "success",
      "transcribed_text": "Merhaba, bankamıza hoş geldiniz",
      "detected_intent": "greeting",
      "confidence": 0.92,
      "execution_time_ms": 3200
    }
  ],
  "performance_metrics": {
    "total_duration_ms": 150000,
    "successful_steps": 4,
    "failed_steps": 0
  }
}
```

### Integration Points
- **Test Controller**: Main orchestration service
- **OpenSIPS**: Call management and audio routing
- **ASR/TTS Services**: Audio processing
- **Intent Service**: Response classification
- **SQLite Database**: Scenario storage and result persistence

### Testing
**Test File Location**: `core/tests/test_scenario_execution.py`
**Test Standards**: Integration tests for full execution workflow
**Testing Framework**: pytest with mock IVR responses
**Specific Requirements**:
- Test scenario loading and validation
- Mock IVR interaction testing
- Verify conditional logic execution
- Test result generation and storage
- Performance and timing validation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-27 | 1.0 | Initial story creation | System Architect |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will be added here*
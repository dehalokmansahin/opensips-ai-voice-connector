# Story 0.4: Core Module Refactoring for IVR Testing Architecture

## Overview
**Epic:** Refactoring Series (Epic 0)  
**Story Points:** 8  
**Priority:** High  
**Dependencies:** Story 0.1 (LLM Removal), Story 0.2 (SQLite Infrastructure), Story 0.3 (Intent Recognition)

## Problem Statement
The current core module architecture was designed for conversational AI use cases and contains components not aligned with IVR testing requirements. The module needs refactoring to support the new Test Controller architecture, DTMF generation, and simplified service orchestration for automated telephony testing.

## User Story
As a developer implementing IVR test automation, I need the core module restructured to support test scenario orchestration, DTMF tone generation, and intent-based validation workflows instead of conversation management.

## Acceptance Criteria

### AC1: Test Controller Integration Foundation
- [ ] Remove conversation-focused bot pipeline manager
- [ ] Create test controller base classes and interfaces
- [ ] Implement test execution state management
- [ ] Add test scenario orchestration capabilities

### AC2: DTMF Generation Module
- [ ] Create DTMF tone generation module in core
- [ ] Implement RTP-based tone injection for OpenSIPS
- [ ] Add timing and sequence control for DTMF tones
- [ ] Integrate with test execution workflow

### AC3: Simplified Service Orchestration
- [ ] Refactor gRPC client management for test-focused services
- [ ] Remove conversation-specific session management
- [ ] Implement test execution session management
- [ ] Add intent recognition client integration

### AC4: Audio Processing Alignment
- [ ] Adapt audio processing for IVR test scenarios
- [ ] Remove streaming conversation features
- [ ] Implement prompt-response audio handling
- [ ] Optimize for test execution timing

### AC5: Configuration Restructuring
- [ ] Update configuration schema for test scenarios
- [ ] Remove LLM-related configuration remnants
- [ ] Add test execution and DTMF configuration
- [ ] Implement intent recognition configuration

## Technical Tasks

### Task 1: Bot Module to Test Controller Transformation
```python
# Current: core/bot/pipeline_manager.py + session.py
# New: core/test_controller/execution_manager.py + test_session.py

# Remove:
- ConversationSession class
- PipelineManager conversation logic
- Streaming conversation features

# Add:
- TestExecutionSession class
- TestExecutionManager class
- Test scenario state management
- Step-by-step execution control
```

### Task 2: DTMF Generation Module
```python
# New: core/dtmf/generator.py

class DTMFGenerator:
    """Generate and inject DTMF tones into RTP streams"""
    
    async def send_dtmf_sequence(self, call_id: str, sequence: str, timing: DTMFTiming)
    async def send_single_tone(self, call_id: str, tone: str, duration_ms: int)
    async def validate_dtmf_capability(self, call_id: str) -> bool

class DTMFTiming:
    """DTMF timing configuration"""
    tone_duration: int = 100  # ms
    pause_duration: int = 100  # ms
    sequence_delay: int = 500  # ms
```

### Task 3: Service Client Refactoring
```python
# Update: core/grpc_clients/service_registry.py
# Add intent recognition client
# Remove LLM client references
# Optimize for test execution patterns

# New: core/grpc_clients/intent_client.py
class IntentRecognitionClient:
    async def classify_intent(self, text: str) -> IntentResult
    async def batch_classify(self, texts: List[str]) -> List[IntentResult]
```

### Task 4: Audio Processing Optimization
```python
# Update: core/audio/ modules
# Remove streaming conversation features
# Add prompt-response cycle handling
# Optimize for test execution timing requirements

# New: core/audio/test_audio.py
class TestAudioProcessor:
    """Audio processing optimized for IVR testing"""
    
    async def process_prompt_audio(self, audio: bytes) -> bytes
    async def process_response_audio(self, audio: bytes) -> bytes
    async def handle_ivr_audio_cycle(self, prompt: str) -> str
```

### Task 5: Configuration Schema Updates
```python
# Update: core/config/settings.py

@dataclass
class TestExecutionConfig:
    """Configuration for test execution"""
    timeout_seconds: int = 30
    retry_attempts: int = 3
    dtmf_timing: DTMFTiming = field(default_factory=DTMFTiming)
    intent_confidence_threshold: float = 0.8

@dataclass
class ServicesConfig:
    """Updated services configuration without LLM"""
    asr: ServiceConfig
    tts: ServiceConfig
    intent_recognition: ServiceConfig  # New service
    test_controller: ServiceConfig     # New service
```

## File Structure Changes

### Files to Remove
```
core/bot/pipeline_manager.py (replace with test_controller)
core/bot/session.py (replace with test_session)
core/pipecat/ (conversation-specific Pipecat integration)
```

### Files to Create
```
core/test_controller/
├── __init__.py
├── execution_manager.py    # Main test orchestration
├── test_session.py         # Individual test execution
└── state_management.py     # Test state tracking

core/dtmf/
├── __init__.py
├── generator.py            # DTMF tone generation
└── timing.py              # DTMF timing control

core/grpc_clients/
└── intent_client.py        # Intent recognition client

core/audio/
└── test_audio.py          # Test-optimized audio processing
```

### Files to Update
```
core/__init__.py            # Update exports
core/config/settings.py     # New configuration schema
core/grpc_clients/__init__.py # Add intent client
core/opensips/rtp_transport.py # DTMF injection support
core/utils/audio.py        # Test audio utilities
```

## Testing Requirements

### Unit Tests
- [ ] Test execution manager functionality
- [ ] DTMF generation and timing
- [ ] Intent recognition client integration
- [ ] Test session state management
- [ ] Audio processing for test scenarios

### Integration Tests
- [ ] End-to-end test execution flow
- [ ] DTMF tone injection with OpenSIPS
- [ ] Service client coordination
- [ ] Configuration loading and validation

### Test Files to Create
```
core/tests/
├── test_execution_manager.py
├── test_dtmf_generator.py
├── test_intent_client.py
└── test_audio_processing.py
```

## Development Notes

### Architecture Alignment
- Transforms core from conversation AI to test automation
- Maintains existing ASR/TTS service integration
- Adds new test orchestration capabilities
- Supports step-by-step test execution

### Performance Considerations
- Optimize for test execution speed vs. conversation quality
- Minimize latency in prompt-response cycles
- Efficient DTMF timing for IVR navigation
- Intent recognition should be fast and accurate

### Migration Strategy
1. Create new test controller modules alongside existing bot modules
2. Gradually migrate functionality from bot to test controller
3. Update service integrations one by one
4. Remove deprecated bot modules after verification
5. Update all imports and dependencies

## Definition of Done
- [ ] All conversation-specific components removed or transformed
- [ ] Test controller architecture implemented and functional
- [ ] DTMF generation module operational with OpenSIPS
- [ ] Intent recognition client integrated and tested
- [ ] Configuration schema updated for IVR testing
- [ ] All unit and integration tests passing
- [ ] Documentation updated for new architecture
- [ ] Core module exports aligned with new structure

## Dependencies and Blockers
- **Requires:** Story 0.3 (Intent Recognition Service) for client integration
- **Requires:** Story 0.2 (SQLite Infrastructure) for test state storage
- **Blocks:** Epic 1 stories requiring test controller functionality
- **Blocks:** Epic 2 stories requiring DTMF and intent recognition

## Estimated Effort
- **Development:** 5-6 days
- **Testing:** 2 days  
- **Documentation:** 1 day
- **Total:** 8-9 days

## Success Metrics
- Core module successfully supports test execution workflows
- DTMF generation functional with OpenSIPS integration
- Intent recognition client operational
- Test execution sessions replace conversation sessions
- All existing ASR/TTS functionality preserved and optimized for testing
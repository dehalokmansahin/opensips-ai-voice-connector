# Story 1.2: Test Controller Service

## Status
Draft

## Story
**As a** test orchestrator,  
**I want** a simple service to manage test execution,  
**so that** I can coordinate calls and audio processing.

## Acceptance Criteria
1. Test Controller service with REST API
2. Integration with OpenSIPS for call initiation
3. Coordination with existing ASR/TTS services
4. Basic test scenario storage (SQLite)
5. Test execution logging and results storage

## Tasks / Subtasks
- [ ] Create Test Controller service structure (AC: 1)
  - [ ] Create `services/test-controller-service/` directory
  - [ ] Set up FastAPI REST API server
  - [ ] Implement basic health checks
  - [ ] Configure service on port 50055
- [ ] Implement OpenSIPS integration (AC: 2)
  - [ ] Create OpenSIPS MI client for call control
  - [ ] Implement call initiation methods
  - [ ] Add call status monitoring
  - [ ] Handle call termination and cleanup
- [ ] Add ASR/TTS service coordination (AC: 3)
  - [ ] Create gRPC clients for ASR service (port 50051)
  - [ ] Create gRPC clients for TTS service (port 50053) 
  - [ ] Implement audio prompt generation workflow
  - [ ] Add response transcription handling
- [ ] Integrate SQLite database (AC: 4)
  - [ ] Connect to test scenarios database
  - [ ] Implement basic CRUD operations for test scenarios
  - [ ] Add test scenario validation
  - [ ] Create database connection management
- [ ] Add execution logging and results (AC: 5)
  - [ ] Implement test execution tracking
  - [ ] Create execution result storage
  - [ ] Add structured logging for test steps
  - [ ] Store call recordings and transcripts

## Dev Notes

### Relevant Source Tree Info
- **Service Location**: `services/test-controller-service/` - new service
- **Main Entry**: `services/test-controller-service/src/main.py`
- **gRPC Server**: `services/test-controller-service/src/test_controller_grpc_server.py`
- **Scenario Executor**: `services/test-controller-service/src/scenario_executor.py`
- **Docker**: `services/test-controller-service/Dockerfile`
- **Protobuf**: `shared/proto/test_controller.proto`

### Architecture Context
The Test Controller is the central orchestration service that coordinates all components for IVR testing. It manages the flow: TTS → OpenSIPS → IVR → OpenSIPS → ASR → Intent Recognition → Results. This service follows the same gRPC microservices pattern as existing ASR/TTS services.

### Service API Design
```python
# REST API Endpoints
POST /api/v1/test-executions/start    # Start test execution
GET /api/v1/test-executions/{id}      # Get execution status  
POST /api/v1/test-executions/{id}/stop # Stop execution
GET /api/v1/test-scenarios            # List scenarios
POST /api/v1/test-scenarios           # Create scenario
```

### Integration Points
- **OpenSIPS MI Interface**: Call control via HTTP/socket interface
- **ASR Service**: gRPC client to existing service (port 50051)
- **TTS Service**: gRPC client to existing service (port 50053)
- **SQLite Database**: Direct connection to test data
- **Intent Service**: Will be integrated in Epic 2

### Test Execution Workflow
1. Load test scenario from SQLite
2. Generate TTS audio for first prompt
3. Initiate outbound call via OpenSIPS MI
4. Send audio prompt to IVR
5. Capture IVR response via ASR
6. Store results and continue to next step

### Docker Integration
```yaml
test-controller:
  build: ./services/test-controller-service
  ports: ["50055:50055"]
  environment:
    - TEST_CONTROLLER_LISTEN_ADDR=[::]:50055
    - ASR_SERVICE_URL=asr-service:50051
    - TTS_SERVICE_URL=tts-service:50053
    - DATABASE_PATH=/app/data/test_scenarios.db
```

### Testing
**Test File Location**: `services/test-controller-service/tests/test_controller_service.py`
**Test Standards**: Follow existing service testing patterns (ASR/TTS)
**Testing Framework**: pytest with FastAPI test client
**Specific Requirements**:
- Test REST API endpoints functionality
- Mock OpenSIPS MI interface integration
- Test ASR/TTS service integration
- Verify database operations
- Test execution workflow end-to-end

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-27 | 1.0 | Initial story creation | System Architect |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will be added here*
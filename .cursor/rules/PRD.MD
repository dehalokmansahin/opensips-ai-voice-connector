
# ğŸš€ PRD â€“ Pipecat IVR Sanal Asistan (GeliÅŸtirici Dostu)

---

## 1. AmaÃ§

Bu dokÃ¼man, bir banka Ã§aÄŸrÄ± merkezi iÃ§in geliÅŸtirilecek olan **Pipecat tabanlÄ± gerÃ§ek zamanlÄ± sanal asistan** projesinin teknik gereksinimlerini ve Ã¼rÃ¼n tanÄ±mÄ±nÄ± iÃ§erir.

-   **Proje Hedefi:** Banka Ã§aÄŸrÄ± merkezi IVR (Interactive Voice Response) sistemini, modern ve akÄ±cÄ± bir diyalog deneyimi sunan bir sanal asistan ile gÃ¼Ã§lendirmek.
-   **Teknoloji OdaÄŸÄ±:** Proje, ses taÅŸÄ±ma katmanÄ± olarak OAVC (Open-Source Audio/Video Conferencing) platformunu kullanacak ve iÅŸ mantÄ±ÄŸÄ± **Pipecat pipeline**'Ä± Ã¼zerinde inÅŸa edilecektir.
-   **Pipeline BileÅŸenleri:**
    -   **VAD (Voice Activity Detection):** KullanÄ±cÄ±nÄ±n ne zaman konuÅŸup ne zaman sustuÄŸunu tespit ederek konuÅŸma segmentleri oluÅŸturma.
    -   **Interruption (Barge-in):** Sanal asistan konuÅŸurken kullanÄ±cÄ±nÄ±n araya girmesine (barge-in) olanak tanÄ±ma.
    -   **Ã‡ekirdek AkÄ±ÅŸ:** GerÃ§ek zamanlÄ± STT (Speech-to-Text) â†’ LLM (Large Language Model) â†’ TTS (Text-to-Speech) akÄ±ÅŸÄ±nÄ± yÃ¶netme.
-   **Ã–rnek Senaryo:** Projenin yeteneklerini sergilemek amacÄ±yla **"Kart Kurye Durumu Sorgulama"** akÄ±ÅŸÄ± pilot olarak geliÅŸtirilecektir.

---

## 2. AkÄ±ÅŸ (High Level)

Sistemin uÃ§tan uca veri akÄ±ÅŸÄ± aÅŸaÄŸÄ±daki gibi olacaktÄ±r:

> **OAVC (PCMU/8000 GiriÅŸi)** â†’ **PCMUâ†’PCM Decode** â†’ **Pipecat Pipeline** â†’ VAD â†’ STT â†’ LLM â†’ TTS â†’ **PCMâ†’PCMU Encode** â†’ **OAVC (PCMU/8000 Ã‡Ä±kÄ±ÅŸÄ±)**

---

## 3. Ses FormatÄ±

-   **GiriÅŸ (OAVC'den):** `PCMU/8000 ulaw` formatÄ± (8-bit, 8kHz, mono).
-   **Paketleme:** OAVC, RTP paketleri aracÄ±lÄ±ÄŸÄ±yla sesi yaklaÅŸÄ±k **20ms'lik parÃ§alar (chunk)** halinde iletir. Bu, `8000 (Ã¶rnek/sn) * 0.020 (sn) * 1 (byte/Ã¶rnek) = 160 byte/frame` boyutuna karÅŸÄ±lÄ±k gelir.
-   **Pipeline Ä°Ã§i Ä°ÅŸleme:** Gelen PCMU ses verisi pipeline iÃ§inde `PCM 16-bit, 16kHz, mono` formatÄ±na decode edilir.
-   **Ã‡Ä±kÄ±ÅŸ (Pipecat'ten):** TTS servisinden Ã¼retilen ses `PCM 24kHz, mono` formatÄ±ndadÄ±r. Bu ses, PSTN (Public Switched Telephone Network) hatlarÄ±na gÃ¶nderilmeden Ã¶nce `PCMU/8000 ulaw` formatÄ±na **encode** edilmelidir.

**Format DÃ¶nÃ¼ÅŸÃ¼m AkÄ±ÅŸÄ±:**
> **PCMU/8000 (giriÅŸ)** â†’ **PCM 16kHz decode** â†’ **Pipeline Ä°ÅŸleme** â†’ **PCM 24kHz (TTS)** â†’ **PCMU/8000 encode (Ã§Ä±kÄ±ÅŸ)**

---

## 4. OAVC â†’ Pipecat BaÄŸlantÄ±sÄ±

OAVC'den Pipecat'e ses akÄ±ÅŸÄ±, Pipecat SDK'sÄ±nÄ±n **`ai.send`** methodu ile gerÃ§ekleÅŸtirilir. OAVC'den alÄ±nan her bir PCM ses parÃ§asÄ± (chunk), bu method aracÄ±lÄ±ÄŸÄ±yla Pipecat pipeline'Ä±na gÃ¶nderilir.

Bu method, OAVC tarafÄ±ndan Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda, arka planda `PipelineManager` sÄ±nÄ±fÄ±ndaki `process_audio_packet` fonksiyonuna eÅŸlenir.


---


## 5. OAVC PCMU Veri Ä°ÅŸleme

OAVC'den gelen her 20ms'lik RTP paketi, PCMU/8000 ulaw formatÄ±nda Pipecat pipeline'Ä±na gÃ¶nderilir.

-   **Ã–rnekleme HesabÄ±:** `0.020 saniye * 8000 Ã¶rnek/saniye = 160 Ã¶rnek`
-   **Byte Boyutu:** `160 Ã¶rnek * 1 byte/Ã¶rnek (8-bit ulaw) = 160 byte`

Bu 160 byte'lÄ±k PCMU chunk, `process_audio_packet` fonksiyonuna argÃ¼man olarak verilir:


---
## 7. VAD Parametreleri

TÃ¼rkÃ§e konuÅŸma iÃ§in Ã¶nerilen baÅŸlangÄ±Ã§ VAD (Silero) parametreleri:

| Parametre | DeÄŸer | AÃ§Ä±klama |
| :--- | :---: | :--- |
| `min_speech_duration_ms` | 200 | Bir sesin konuÅŸma olarak kabul edilmesi iÃ§in gereken minimum sÃ¼re. |
| `min_silence_duration_ms`| 100 | KonuÅŸmanÄ±n bittiÄŸini varsaymak iÃ§in gereken minimum sessizlik sÃ¼resi. |
| `speech_prob_threshold` | 0.5 | Sesin konuÅŸma olma olasÄ±lÄ±ÄŸÄ± eÅŸiÄŸi. |

---

## 8. Interruption (Barge-in)

KullanÄ±cÄ±nÄ±n, asistan konuÅŸurken araya girmesini saÄŸlamak iÃ§in `MinWordsInterruptionStrategy` kullanÄ±lÄ±r. Bu strateji, kullanÄ±cÄ± belirli bir sayÄ±da kelime sÃ¶ylediÄŸinde TTS ses Ã§Ä±kÄ±ÅŸÄ±nÄ± anÄ±nda keser.


## 9. LLM KullanÄ±mÄ±

Pipecat, LLM servisleriyle entegrasyonu basitleÅŸtirir. `OLLamaLLMService` kullanÄ±larak yerel bir LLM'e (Ã¶rneÄŸin Llama 3.2) istek gÃ¶nderilir.
---

## 10. TTS AkÄ±ÅŸÄ±

DoÄŸal ve akÄ±cÄ± TÃ¼rkÃ§e ses Ã§Ä±kÄ±ÅŸÄ± iÃ§in Piper TTS servisi kullanÄ±lÄ±r. Pipecat, bu servise metin gÃ¶nderir ve karÅŸÄ±lÄ±ÄŸÄ±nda ses verisini stream olarak alÄ±r.


## 11. Kart Kurye Durumu Senaryosu

**KullanÄ±cÄ±:** *"Merhaba, kredi kartÄ±mÄ±n durumunu Ã¶ÄŸrenebilir miyim?"* veya *"KartÄ±m nerede?"*

**Pipeline AkÄ±ÅŸÄ±:**

1.  **PCM GiriÅŸi:** KullanÄ±cÄ±nÄ±n sesi OAVC Ã¼zerinden Pipecat'e 640 byte'lÄ±k paketler halinde akar.
2.  **VAD:** KonuÅŸmanÄ±n baÅŸladÄ±ÄŸÄ±nÄ± ve bittiÄŸini algÄ±lar, tam bir ifade segmenti oluÅŸturur.
3.  **STT:** Ses segmentini metne Ã§evirir: `"kartÄ±m nerede"`
4.  **LLM:** Metni iÅŸler, amacÄ± (`intent`) anlar ve uygun cevabÄ± oluÅŸturur.
    -   *Intent:* `kart_kurye_sorgulama`
    -   *LLM CevabÄ± (Ã–rnek):* `"Tabii, hemen kontrol ediyorum. KartÄ±nÄ±z kuryeye verilmiÅŸ olup, tahmini teslimat sÃ¼resi 3 iÅŸ gÃ¼nÃ¼dÃ¼r."`
5.  **TTS:** LLM'in Ã¼rettiÄŸi metni sese dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
6.  **PCM Ã‡Ä±kÄ±ÅŸÄ±:** Ãœretilen ses PCM akÄ±ÅŸÄ± olarak OAVC'ye geri gÃ¶nderilir ve kullanÄ±cÄ±ya dinletilir.

---

## 12. Test SenaryolarÄ±

-   [ ] OAVC'den Pipecat'e PCM aktarÄ±mÄ± baÅŸarÄ±lÄ± bir ÅŸekilde gerÃ§ekleÅŸiyor mu?
-   [ ] VAD, kÄ±sa ve uzun konuÅŸmalarÄ± doÄŸru ÅŸekilde segmentlere ayÄ±rÄ±yor mu?
-   [ ] Asistan konuÅŸurken kullanÄ±cÄ± araya girdiÄŸinde "barge-in" anÄ±nda tetikleniyor mu?
-   [ ] TÃ¼rkÃ§e STT, farklÄ± aksan ve hÄ±zlardaki konuÅŸmalarÄ± doÄŸru deÅŸifre ediyor mu?
-   [ ] LLM, "kart kurye" ile ilgili farklÄ± ifadelerden doÄŸru amacÄ± (`intent`) yakalayabiliyor mu?
-   [ ] TTS tarafÄ±ndan Ã¼retilen PCM ses Ã§Ä±kÄ±ÅŸÄ± temiz, anlaÅŸÄ±lÄ±r ve kesintisiz mi?
-   [ ] Pipeline, `start()` ve `stop()` Ã§aÄŸrÄ±larÄ± arasÄ±nda istikrarlÄ± Ã§alÄ±ÅŸÄ±yor ve kaynak sÄ±zÄ±ntÄ±sÄ± olmadan kapanÄ±yor mu?

---

## 13. Performans Gereklilikleri

KullanÄ±cÄ± deneyiminin akÄ±cÄ± olmasÄ± iÃ§in hedeflenen gecikme sÃ¼releri:

| AdÄ±m | Hedef SÃ¼re (ms) | AÃ§Ä±klama |
| :--- | :---: | :--- |
| VAD â†’ STT | â‰¤ 500 | KullanÄ±cÄ± sustuktan sonra metnin Ã¼retilme sÃ¼resi. |
| STT â†’ LLM | â‰¤ 400 | Metnin LLM'e gidip ilk cevabÄ±n gelme sÃ¼resi (TTFB).|
| LLM â†’ TTS | â‰¤ 700 | LLM cevabÄ±nÄ±n ilk ses paketine dÃ¶nÃ¼ÅŸme sÃ¼resi. |
| **Toplam Round-Trip** | **â‰¤ 1.5 saniye** | KullanÄ±cÄ± sustuktan sonra asistanÄ±n konuÅŸmaya baÅŸlama sÃ¼resi. |


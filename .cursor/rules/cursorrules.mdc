---
description: 
globs: 
alwaysApply: true
---
# ğŸ¯ OpenSIPS AI Voice Connector - Cursor Rules

## ğŸ“‹ Proje DokÃ¼manlarÄ±
[PRD.MD](mdc:.cursor/rules/PRD.MD)
[event and mi datagram.md](mdc:.cursor/rules/event and mi datagram.md)
[example_opensips.md](mdc:.cursor/rules/example_opensips.md)
[pipecat implementations.md](mdc:.cursor/rules/pipecat implementations.md)
## ğŸ—ï¸ Proje Mimarisi

Bu proje, **Pipecat** tabanlÄ± gerÃ§ek zamanlÄ± ses iÅŸleme pipeline'Ä± ile Ã§alÄ±ÅŸan bir IVR sanal asistan sistemidir.

### Temel BileÅŸenler:
- **OAVC (OpenSIPS Audio/Video Connector)**: Ses taÅŸÄ±ma katmanÄ±
- **STT**: VOSK tabanlÄ± konuÅŸma tanÄ±ma
- **LLM**: Llama3.2 ile doÄŸal dil iÅŸleme
- **TTS**: Piper ile metin-ses dÃ¶nÃ¼ÅŸÃ¼mÃ¼
- **Pipecat Pipeline**: VAD â†’ STT â†’ LLM â†’ TTS akÄ±ÅŸÄ±


## ğŸ’» Kod YazÄ±m StandartlarÄ±

### Python GeliÅŸtirme KurallarÄ±:
1. **Type Hints KullanÄ±mÄ±**: TÃ¼m fonksiyonlarda type hints zorunlu
```python
async def process_audio_packet(self, pcm_bytes: bytes) -> None:
    pass
```

2. **Async/Await Pattern**: TÃ¼m I/O operasyonlarÄ± async olmalÄ±
3. **Error Handling**: Try-catch bloklarÄ± ile kapsamlÄ± hata yÃ¶netimi
4. **Logging**: Structured logging ile detaylÄ± log kayÄ±tlarÄ±
5. **Docstrings**: Google style docstrings kullanÄ±m

### Dosya Organizasyonu:
```
src/
â”œâ”€â”€ pipeline/          # Pipecat pipeline components
â”œâ”€â”€ services/          # External service integrations
â”œâ”€â”€ utils/            # Utility functions
â”œâ”€â”€ models/           # Data models and schemas
â””â”€â”€ config/           # Configuration management
```

## ğŸ”§ GeliÅŸtirme TalimatlarÄ±

### Yeni Feature GeliÅŸtirme:
1. Ã–nce `PRD.MD` dosyasÄ±nÄ± kontrol et
2. `RAG Pipecat.md` iÃ§indeki ilgili MVP'yi incele
3. Test-driven development yaklaÅŸÄ±mÄ± kullan
4. Pipeline pattern'ine uygun kod yaz

### Pipeline GeliÅŸtirme:
- TÃ¼m pipeline bileÅŸenleri `PipelineManager` Ã¼zerinden yÃ¶netilmeli
- Frame-based processing pattern'ini takip et
- Interruption handling iÃ§in MinWordsInterruptionStrategy kullan
- VAD parametrelerini TÃ¼rkÃ§e konuÅŸma iÃ§in optimize et

### Ses Ä°ÅŸleme:
- OAVC input: PCMU/8000 ulaw format (8-bit, 8kHz, mono)
- Pipeline decode: PCM 16-bit, 16kHz, mono (internal processing)
- Pipeline output: PCM 24kHz, mono (TTS Ã§Ä±kÄ±ÅŸÄ±)
- PSTN output: PCMU/8000 ulaw format (8-bit, 8kHz, mono)
- Chunk size: 160 bytes (20ms frames)
- Hesaplama: 8000 sample/s Ã— 0.020s Ã— 1 byte = 160 bytes/frame

### Performans Hedefleri:
- VAD â†’ STT: â‰¤ 500ms
- STT â†’ LLM: â‰¤ 400ms  
- LLM â†’ TTS: â‰¤ 700ms
- **Total Round-Trip: â‰¤ 1.5 saniye**

## ğŸ§ª Test Stratejisi

### Kritik Test AlanlarÄ±:
- [ ] OAVC â†” Pipecat baÄŸlantÄ± testi
- [ ] VAD segmentasyon doÄŸruluÄŸu
- [ ] Barge-in (interruption) timing
- [ ] TÃ¼rkÃ§e STT accuracy (>92%)
- [ ] LLM intent detection
- [ ] TTS ses kalitesi
- [ ] End-to-end latency measurement

### Test KomutlarÄ±:
```bash
# Unit tests
python -m pytest tests/unit/

# Integration tests  
python -m pytest tests/integration/

# Performance tests
python -m pytest tests/performance/ --benchmark
```

## ğŸ“Š Monitoring ve Observability

### Metrics Tracking:
- Audio processing latency
- STT accuracy rates
- LLM response times
- TTS generation speed
- Pipeline error rates
- Memory usage patterns

### Logging Requirements:
```python
import structlog

logger = structlog.get_logger()

# Her pipeline stage'inde log
logger.info("audio_processed", 
           stage="vad", 
           duration_ms=processing_time,
           frame_size=len(pcm_bytes))
```

## ğŸ”’ Security Considerations

- PII data handling protocols
- Audio data encryption in transit
- LLM input sanitization
- Rate limiting for API calls
- Secure configuration management

## ğŸš€ Deployment

### Development Environment:
```bash
docker-compose -f docker-compose.dev.yml up
```

### Production Deployment:
- Kubernetes manifests in `/openshift/`
- ConfigMaps for environment-specific settings
- Health checks ve readiness probes
- Resource limits ve requests tanÄ±mlarÄ±

## ğŸ“ Commit Conventions

```
feat(pipeline): add voice activity detection
fix(tts): resolve audio quality issues  
docs(readme): update installation guide
test(vad): add unit tests for segmentation
refactor(llm): improve error handling
```

B2b ModÃ¼lÃ¼nÃ¼ kullanmak gerekirse @b2b_entities usage.md bilgileri referans alÄ±nabilir


## ğŸ¤ Code Review Checklist

- [ ] Type hints mevcut
- [ ] Error handling uygulanmÄ±ÅŸ
- [ ] Tests yazÄ±lmÄ±ÅŸ
- [ ] Performance impact deÄŸerlendirilmiÅŸ
- [ ] Documentation gÃ¼ncellenmiÅŸ
- [ ] Security implications kontrol edilmiÅŸ